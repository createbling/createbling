(function(){ovi.provide("nokia.maps.heatmap._StackBlur");
(nokia.maps.heatmap.gq=function(){}).prototype={blurContext:function(h,g,f,c,a,j,b,e){h=this.blurData(h.getImageData(c,a,j,b),f,j,b,e||15);g.putImageData(h,c,a)},blurData:function(h,g,f,c,a){this.blurArray(h.data,g,f,c,a);return h},blurArray:function(h,g,f,c,a){a&1&&this.convolve(h,h,g,f,c,0);a&2&&this.convolve(h,h,g,f,c,1);a&4&&this.convolve(h,h,g,f,c,2);a&8&&this.convolve(h,h,g,f,c,3);return h},convolve:function(h,g,f,c,a,j){var b=(f+1)*(f+1),e,l,d,n,k,m,p,r,q,u=c*4,s=f+1,w,x=[{r:0,g:0,b:0,a:0,
next:null}];p=1;var y=["r","g","b","a"][j];d=2*f+1;for(var v,z,B;p<d;p++)x[p]={r:0,g:0,b:0,a:0,next:null},x[p-1].next=x[p];x[2*f].next=x[0];z=(c-1)*4;for(l=0;l<a;l++){m=l*u;e=h[m+j];k=e*s*(f+2)/2;d=e*s;for(p=0;p<=f;p++)x[p][y]=e;n=0;for(p=1;p<=f;p++)r=p<c?m+p*4:m+z,r=h[r+j],k+=r*(s-p),n+=r,x[f+p][y]=r;r=x[0];v=x[s];p=m;B=s*4;rowEnd=m+z;for(e=0;e<c;e++)if(g[p+j]=k/b,k-=d,q=e+s<c?p+B:rowEnd,q=h[q+j],n+=q,k+=n,d-=r[y],d+=v[y],n-=v[y],r[y]=q,r=r.next,v=v.next,p+=4,!k)for(;(w=(e+s)*4)<u&&h[m+j+w]==0;)e++,
p+=4}m=(a-1)*u;for(e=0;e<c;e++){h=e*4;l=g[h+j];k=l*s*(f+2)/2;d=l*s;for(p=0;p<=f;p++)x[p][y]=l;n=0;for(p=1;p<=f;p++)r=p<a?h+p*u:h+m,r=g[r+j],k+=r*(f-p+1),n+=r,x[f+p][y]=r;r=x[0];v=x[s];p=h;z=s*u;colEnd=h+m;for(l=0;l<a;l++)if(g[p+j]=k/b,k-=d,q=l+s<a?p+z:colEnd,q=g[q+j],n+=q,k+=n,d-=r[y],d+=v[y],n-=v[y],r[y]=q,r=r.next,v=v.next,p+=u,!k)for(;(w=l+s)<a&&g[w*u+j+h]==0;)l++,p+=u}}};ovi.provide("nokia.maps.heatmap._TileRenderer");
(function(h){function g(a,b){return a.stop-b.stop}var f=Math,c=f.floor,a=f.log,j=h.heatmap,b=h.util,e=b.c;j.hq=ovi.Class({Statics:{DEFAULT_COLORS:{stops:{0:"#008","0.2":"#0b0","0.5":"#ff0","0.7":"#f00"},interpolate:!0}},initialize:function(c,d,f){c>>=d;this.gt=d;this.pr=c;this.wr=a(c)/a(2);this.sq=d=document.createElement("canvas");this.tq=d.getContext("2d");this.uq=d.width=d.height=c*3;this.Qn=new j.gq;var h=document.createElement("canvas"),m,d=f.interpolate,p=f.stops,c=[],r,q,u;h.width=256;h.height=
1;h=h.getContext("2d");for(m in p)p.hasOwnProperty(m)&&c.push({stop:parseFloat(m),value:p[m]});p=c.length;p<2&&b.c("The heat map colors definition must have at least two values.");c.sort(g);c[0].stop>0&&c.unshift({stop:0,value:c[0].value});c[p-1].stop<1&&c.push({stop:1,value:c[p-1].value});p=c.length;m=h.createLinearGradient(0,0,256,0);for(r=0;r<p;r++)isNaN(c[r].stop)&&e("Stop offset for heat map color definitions must be parseable floats."),!d&&q&&(u=q.stop+(c[r].stop-q.stop)/2,m.addColorStop(u,
q.value),m.addColorStop(u,c[r].value)),m.addColorStop(c[r].stop,c[r].value),q=c[r];h.fillStyle=m;h.fillRect(0,0,256,1);this.zq=h.getImageData(0,0,256,1).data;this.qr=f.interpolate},paint:function(a,b,e,j,g,h,r,q,u){var b=this.pr,j=this.tq,s,w=h==="density"?2:1,x=w,e=f.min(e+w,this.wr),y,v,z,B,E,w=this.uq,H;g&&h==="value"?this.Ur(a,r,q,u,j,b,w):(j.fillStyle=g?"#080":"#000",j.fillRect(0,0,w,w));for(;x<=e&&r+x<=a.Ub;x++){B=b>>x;offset=b-B;H=h==="density"?127+c(128/(1<<e-x)):255;E=(1<<x)+2;g=this.ar(a,
x,r,q,u,!1);for(y=g.length;y--;)if(v=y%E,z=y/E<<0,s=g[y])s=a.jj(s.average),j.fillStyle="rgba("+s+","+H+",0,1)",j.fillRect(v*B+offset,z*B+offset,B,B);this.Qn.blurContext(j,j,B,offset,offset,b+2*B,b+2*B,3)}a=this.Aq(j.getImageData(0,0,w,w),this.zq,this.qr);j.putImageData(a,0,0);return[this.sq,b]},Aq:function(a,b,c){for(var e=a.data,f,j,g=0,h=e.length;g<h;g+=4)f=e[g],j=e[g+1],b.length==4&&(f=0),e[g]=b[f*4],e[g+1]=b[f*4+1],e[g+2]=b[f*4+2],e[g+3]=b[f*4+3]*(c?j/255:j<10?0:1);return a},Ur:function(a,b,e,
f,j,g,h){var q,u,s;for(s=-1;s<=1;s++)for(u=-1;u<=1;u++)q=(q=a.getQuad(b,e+s,f+u,!0))?a.jj(q.average):128,j.fillStyle="rgba("+q+",128,0,1)",j.fillRect((u+1)*g,(s+1)*g,g,g);this.Qn.blurContext(j,j,g-c(g/10),0,0,h,h,3)},ar:function(a,b,c,e,f,j){var g=1<<b;f<<=b;e<<=b;return a.getQuads(c+b,e-1,e+g,f-1,f+g,j)}})})(nokia.maps);ovi.provide("nokia.maps.heatmap._TileHashMap");
(function(h){var g=h.heatmap,f=h.geo.mercator,c=h.util.me,h=Math,a=h.round,j=h.log,b=h.pow,e=g.Ci=new ovi.Class({initialize:function(a,b,c){var e=0;this.Ub=a>30?30:a<0?0:a;this.dl=c||this.Ub;b==="value"?(this.Em=l,this.jj=this.Br):(this.Em=d,this.jj=this.Ar);this.Rb=[];this.Zc=[];for(e=0;e<=a;e++)this.Zc[e]=[],this.Rb[e]=new n;this.gj=-1/0;this.ih=1/0;this.Oi=null},Zc:null,Rb:null,Ub:null,addDataPoint:function(a){var b=f.latLngToMapPoint(a.latitude,a.longitude),d=this.Ub,c=b.x>>30-this.Ub,b=b.y>>
30-this.Ub,e,j=this.Em;e=a.value==null?1:a.value;if(e>this.gj)this.gj=e,this.Oi=this.gj-this.ih;if(e<this.ih)this.ih=e,this.Oi=this.gj-this.ih;for(;d>=0;){this.Zc[d][b]||(this.Zc[d][b]=[]);e=this.Zc[d][b][c]||(this.Zc[d][b][c]=new j);e.addDataPoint(a,this.Ub,d);if(this.Rb[d].minSum>e.sum)this.Rb[d].minSum=e.sum;if(this.Rb[d].maxSum<e.sum)this.Rb[d].maxSum=e.sum;if(this.Rb[d].minAverage>e.average)this.Rb[d].minAverage=e.average;if(this.Rb[d].maxAverage<e.average)this.Rb[d].maxAverage=e.average;d--;
c>>=1;b>>=1}},getQuad:function(a,b,d,e){d=c(d,1<<a);return(quad=(rowInRange=b>=0&&b<=(1<<a)-1)&&this.Zc[a]&&this.Zc[a][b]&&this.Zc[a][b][d]||null)?quad:e&&a>=0?this.getQuad(a-1,b>>1,d>>1,e):quad},getQuads:function(a,b,d,c,e,f){for(var j=c,g=[];b<=d;b++){for(;j<=e;j++)g.push(this.getQuad(a,b,j,f));j=c}return g},clear:function(){e.call(this,this.Ub,this.Em==l?"value":"density",this.dl)},Vs:function(){var b,d,c=this.Rb,e=this.Ub,f=0;d=c[this.Ub].maxSum;for(b=this.Ub;b>=0;b--)if(c[b].maxSum===d)f=b;else break;
d=c[0].maxSum;for(b=0;b<=f;b++)if(d===c[b].maxSum)e=b;else break;if(f>this.dl)f=this.dl;b=a(e+(f-e)/2);this.gamma=j(0.5)/j(c[b].maxAverage);this.pt=e;this.ot=f},jj:null,Ar:function(d){return this.gamma!=null?a(b(d,this.gamma)*255):127},Br:function(b){return this.Oi?a((b-this.ih)/this.Oi*255):127}}),l=g.Ci.ValueQuad=function(){this.count=this.sum=this.average=0},d,n;l.prototype={addDataPoint:function(a){this.sum+=a.value!=null?a.value:1;this.average=this.sum/++this.count}};d=g.Ci.DensityQuad=function(){this.count=
this.sum=this.average=0};d.prototype={addDataPoint:function(a,d,c){this.count++;this.sum+=a.value||1;this.average=this.sum/b(2,(30-c)*2)}};n=g.Ci.Level=function(){this.minSum=this.minAverage=Number.POSITIVE_INFINITY;this.maxSum=this.maxAverage=Number.NEGATIVE_INFINITY}})(nokia.maps);ovi.provide("nokia.maps.heatmap.Overlay");
(function(h){var g=h.util,f=h.heatmap,c=h.map.provider,a=g.Coroutine,j=f.Ci,b=f.hq,e=h.map.provider.Tile,h=h.dom.Page.browser,l=h.mozilla&&h.fullVersion=="7.0",d=function(){var a;a=null;a===null&&(a=document.createElement("canvas"),a=!(!a.getContext||!a.getContext("2d")));return a}();f.Overlay=new ovi.Class({Extends:c.TileProvider,Statics:{TYPE_DENSITY:"density",TYPE_VALUE:"value"},initialize:function(a){d||g.fc("Heat maps are not supported in this environment, due to missing canvas support.");var c=
Math,a=a||{};this._super(a);this.height=this.width=256;this.type=this.type||"density";this.sampleDepth=this.sampleDepth==null?4:c.min(c.max(this.sampleDepth,1),8);this.assumeValues=!!this.assumeValues;this.dataMax=this.dataMax||this.max;this.coarseness=this.coarseness==null?1:c.min(c.max(this.coarseness,0),3);this.opacity=a.opacity||0.8;this.colors=this.colors||b.DEFAULT_COLORS;this.Gf=new j(this.max+this.sampleDepth,this.type,this.dataMax);this.Os=new b(this.width,this.coarseness,this.colors);this.pc=
[];this.td={};this.Dh(this)},addData:function(a){for(var b=0,d=a.length;b<d;b++)this.Gf.addDataPoint(a[b]);this.type==="density"&&this.Gf.Vs();this.update()},clear:function(){this.Gf.clear();this.update()},create:function(b,d,c,f){var j=b<=this.max&&b>=this.min,g=this.assumeValues,h,l;if(!this.Gf.getQuad(0,0,0))return!1;if(j){if(!g){h=this.Gf.getQuads(b,d-1,d+1,c-1,c+1);for(l=h.length;l--&&!g;)h[l]!=null&&(g=!0)}g&&(h=new e(f,0,this),this.Ea[f]=h,this.pc.push({id:f,level:b,row:d,col:c}),a.signal(this.td))}return j&&
g},Dh:a.create("nokia.maps.heatmap.Overlay#_paintCo",function(b){for(var b=b.that,d,c=this.width,e,f,j;e=b.pc.shift();)if(d=this.Ea[e.id])if(f=document.createElement("canvas"),f.width=f.height=c,j=f.getContext("2d"),e=b.Os.paint(b.Gf,c,b.sampleDepth,b.dataMax,b.assumeValues,b.type,e.level,e.row,e.col),j.drawImage(e[0],e[1],e[1],e[1],e[1],0,0,c,c),l&&j.drawImage(f,0,0),d.R=f,this.finishRequest(d.id,d,1),a.shallYield())return a.yield();return a.wait(b.td)},{useAnimationFrame:!0},"that")})})(nokia.maps);
ovi.provide("nokia.maps.heatmap._packaging.package-heatmap");})();
